---
title: 批量任务拆分

categories:
  - [JavaScript]
tags: 
  - JavaScript
---

# 批量任务拆分

```ts
/*
 * @Author: Akira
 * @Date: 2023-05-08 13:56:25
 * @LastEditTime: 2023-05-08 15:03:39
 */
/** id 生成器 */
const genId = (function () {
  let id = 0;
  return function () {
    return ++id;
  };
})();

/**
 * id 缓存
 * key: _requestIdleCallback 返回 id
 * value: requestAnimationFrame 返回 id
 */
const idMap: {
  [key: number]: number;
} = {};

/**
 * 模拟 requestIdleCallback
 * 主要利用 requestAnimationFrame、web workers(MessageChannel)
 * @param cb
 * @param options
 * @returns
 */
const _requestIdleCallback: (cb: (idleDeadline: IdleDeadline) => void, options?: { timeout: number }) => number = function (cb, options) {
  /** 新建通道 */
  const { port1, port2 } = new MessageChannel();

  /** 超时时间 */
  let deadlineTime: number;
  /** 当前帧的截止时间 */
  let frameDeadlineTime: number;
  /** requestIdleCallback 执行回调 */
  let callback: (idleDeadline: IdleDeadline) => void;

  /** 生成 id */
  const id = genId();

  /** port2 进程 onmessage 监听 */
  port2.onmessage = () => {
    /n** 获取当前帧剩余时间 */;
    const frameTimeRemaining = () => frameDeadlineTime - performance.now();
    /** 是否超时 */
    const didTimeout = performance.now() >= deadlineTime;

    if (didTimeout || frameTimeRemaining() > 0) {
      /** 有空闲时间 */
      const idleDeadline = {
        timeRemaining: frameTimeRemaining,
        didTimeout,
      };
      callback && callback(idleDeadline);
    } else {
      /** 帧剩余时间不足,放到下一帧 */
      idMap[id] = requestAnimationFrame((timeStamp) => {
        frameDeadlineTime = timeStamp + 16.7;
        port1.postMessage(null);
      });
    }
  };

  /**  timeStamp 默认参数 当前帧时间戳 */
  idMap[id] = window.requestAnimationFrame((timeStamp) => {
    /** 总帧长 */
    frameDeadlineTime = timeStamp + 16.7;
    /** 超时时间 */
    deadlineTime = options?.timeout ? timeStamp + options.timeout : Infinity;
    callback = cb;
    /** 通知 port2 执行 onmessage 回调 */
    port1.postMessage(null);
  });

  return id;
};

/** 取消预渲染回调执行 */
const _cancelIdleCallback = function (id: number) {
  if (!idMap[id]) return;
  window.cancelAnimationFrame(idMap[id]);
  delete idMap[id];
};

export const requestIdleCallback = window.requestIdleCallback || _requestIdleCallback;
export const cancelIdleCallback = window.cancelIdleCallback || _cancelIdleCallback;
```

# 参考资料

[批量任务导致页面卡死？怎么办？任务拆分？](https://mp.weixin.qq.com/s/ohPLuv3C0diBwp4cTWqsHw)

[requestIdleCallback](https://developer.mozilla.org/zh-CN/docs/Web/API/Window/requestIdleCallback#语法)

[Window：requestAnimationFrame()](https://developer.mozilla.org/zh-CN/docs/Web/API/Window/requestAnimationFrame#规范)

[MessageChannel](https://developer.mozilla.org/zh-CN/docs/Web/API/MessageChannel)
